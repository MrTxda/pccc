<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Phân Tích & Hỗ Trợ PCCC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX for beautiful math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMckDpbOc7ymOqrASb/aWd8doHkZstVHzb+mJQNhCkHIchRjg" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlVwcB3VhMdnvCQtA/3KKgwZoBKOgn3iGnXLqr1浜島" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-btn {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        .tab-btn.active {
            color: #2563eb; /* text-blue-600 */
            background-color: #ffffff;
            border-bottom-color: #2563eb;
        }
        .tab-btn:not(.active) {
            color: #4b5563; /* text-gray-600 */
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl">
        <div class="bg-white text-gray-700 rounded-xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="p-6 bg-slate-800 text-white text-center">
                 <svg class="w-16 h-16 mx-auto text-blue-400 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.455-2.455L12.75 18l1.178-.398a3.375 3.375 0 002.455-2.455L16.5 14.25l.398 1.178a3.375 3.375 0 002.455 2.455L20.25 18l-1.178.398a3.375 3.375 0 00-2.455 2.455z" />
                </svg>
                <h1 class="text-2xl md:text-3xl font-bold">Trợ Lý PCCC Thông Minh</h1>
                <p class="text-slate-300 mt-2">Phân tích, lập kế hoạch, giải thích và tư vấn thiết kế PCCC theo Chuẩn Việt Nam</p>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-200 bg-gray-100 px-2 overflow-x-auto">
                <button id="tab1-btn" class="tab-btn active" onclick="switchTab('tab1')">Phân Tích Rủi Ro</button>
                <button id="tab2-btn" class="tab-btn" onclick="switchTab('tab2')">Lập Kế Hoạch</button>
                <button id="tab3-btn" class="tab-btn" onclick="switchTab('tab3')">Giải Thích Tiêu Chuẩn</button>
                <button id="tab4-btn" class="tab-btn" onclick="switchTab('tab4')">Tư Vấn Thiết Kế</button>
            </div>

            <div class="p-6 md:p-8">
                <!-- Tab 1: Risk Analysis -->
                <div id="tab1" class="tab-content active">
                    <textarea id="userInput1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="5" placeholder="Mô tả tình huống của bạn (ví dụ: nhà kho, chung cư...) để nhận phân tích rủi ro và giải pháp."></textarea>
                    <div class="text-center mt-4"><button id="getAnalysisBtn1" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all duration-300">✨ Phân Tích</button></div>
                </div>

                <!-- Tab 2: Drill Planning -->
                <div id="tab2" class="tab-content">
                    <textarea id="userInput2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="5" placeholder="Mô tả cơ sở của bạn để AI xây dựng một kế hoạch diễn tập PCCC chi tiết."></textarea>
                    <div class="text-center mt-4"><button id="getAnalysisBtn2" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all duration-300">✨ Lập Kế Hoạch</button></div>
                </div>

                <!-- Tab 3: Standard Explainer -->
                <div id="tab3" class="tab-content">
                    <textarea id="userInput3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="5" placeholder="Dán một đoạn tiêu chuẩn, đặt câu hỏi, hoặc dán ảnh chụp văn bản để được giải thích."></textarea>
                    <div id="ocr-status" class="text-center text-sm text-gray-500 mt-2 h-4"></div>
                    <div class="text-center mt-4"><button id="getAnalysisBtn3" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all duration-300">✨ Giải Thích</button></div>
                </div>
                
                <!-- Tab 4: Design Consultation -->
                <div id="tab4" class="tab-content">
                    <textarea id="userInput4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="5" placeholder="Mô tả công trình của bạn (diện tích, số tầng, công năng...) để nhận tư vấn giải pháp thiết kế PCCC."></textarea>
                    <div class="text-center mt-4"><button id="getAnalysisBtn4" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-all duration-300">✨ Tư Vấn Ngay</button></div>
                </div>

                <!-- AI Response Area -->
                <div id="aiResponseContainer" class="mt-6 hidden">
                    <h3 class="text-xl font-bold text-slate-800 mb-3 border-b pb-2">Kết quả từ AI:</h3>
                    <div id="loader" class="flex justify-center items-center py-4"><div class="loader"></div></div>
                    <div id="aiResponse" class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-700"></div>
                </div>
                
                <!-- Suggested Questions Section -->
                <div id="suggestionContainer" class="mt-6 hidden">
                    <h4 class="text-lg font-semibold text-slate-700 mb-3">Câu hỏi gợi ý:</h4>
                    <div id="suggestionButtons" class="flex flex-wrap gap-2">
                        <!-- Suggestion buttons will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- DOM Elements ---
    const buttons = {
        btn1: document.getElementById('getAnalysisBtn1'),
        btn2: document.getElementById('getAnalysisBtn2'),
        btn3: document.getElementById('getAnalysisBtn3'),
        btn4: document.getElementById('getAnalysisBtn4'),
    };
    const inputs = {
        input1: document.getElementById('userInput1'),
        input2: document.getElementById('userInput2'),
        input3: document.getElementById('userInput3'),
        input4: document.getElementById('userInput4'),
    };
    const aiResponseContainer = document.getElementById('aiResponseContainer');
    const aiResponseDiv = document.getElementById('aiResponse');
    const loader = document.getElementById('loader');
    const suggestionContainer = document.getElementById('suggestionContainer');
    const suggestionButtons = document.getElementById('suggestionButtons');
    const ocrStatus = document.getElementById('ocr-status');

    // --- Tab Switching Logic ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById(`${tabId}-btn`).classList.add('active');
    }

    // --- Main API Call Logic ---
    async function getAIResponse(prompt, button) {
        if (!prompt) {
            showModal('Vui lòng nhập nội dung để AI xử lý.');
            return;
        }

        suggestionContainer.style.display = 'none';
        aiResponseContainer.style.display = 'block';
        aiResponseDiv.style.display = 'none';
        loader.style.display = 'flex';
        Object.values(buttons).forEach(b => { b.disabled = true; b.classList.add('opacity-50'); });
        button.textContent = 'Đang xử lý...';
        
        let analysisText = "";

        try {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "AIzaSyACWW1mR0t1epof6pnZPwTFERAS2XKiSCA"; // Provided by environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API call failed: ${response.status}`);

            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                analysisText = result.candidates[0].content.parts[0].text;
            } else {
                analysisText = "Không thể nhận được phản hồi. Vui lòng thử lại.";
            }

            // Clear previous content and add new response + disclaimer
            aiResponseDiv.innerHTML = ''; // Clear old content
            
            const mainContent = document.createElement('div');
            mainContent.innerHTML = analysisText.replace(/\n/g, '<br>');
            aiResponseDiv.appendChild(mainContent);

            const disclaimerDiv = document.createElement('div');
            disclaimerDiv.className = 'mt-4 p-3 bg-amber-100 border-l-4 border-amber-500 text-amber-800 text-sm rounded-r-lg';
            disclaimerDiv.innerHTML = '<strong>Lưu ý:</strong> Gemini có thể mắc sai sót, vì vậy, hãy xác minh các câu trả lời của Gemini.';
            aiResponseDiv.appendChild(disclaimerDiv);
            
            await generateAndShowSuggestions(prompt, analysisText);

        } catch (error) {
            console.error('Error fetching AI analysis:', error);
            aiResponseDiv.textContent = 'Đã xảy ra lỗi khi kết nối với AI. Vui lòng thử lại sau.';
            showSuggestions(); // Show default suggestions on error
        } finally {
            loader.style.display = 'none';
            aiResponseDiv.style.display = 'block';
            Object.values(buttons).forEach(b => { b.disabled = false; b.classList.remove('opacity-50'); });
            button.textContent = button.dataset.originalText;

            // Render math formulas in the response area
            if (window.renderMathInElement) {
                renderMathInElement(aiResponseDiv, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }
    }
    
    // --- OCR from Image Logic ---
    async function extractTextFromImage(base64Data) {
        ocrStatus.textContent = 'Đang nhận diện chữ viết...';
        inputs.input3.disabled = true;
        try {
            const prompt = "Trích xuất toàn bộ văn bản từ hình ảnh này.";
            const parts = [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64Data } }];
            const payload = { contents: [{ role: "user", parts }] };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API call failed: ${response.status}`);
            const result = await response.json();
            let extractedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "";
            inputs.input3.value = extractedText;
            ocrStatus.textContent = '✅ Đã trích xuất văn bản từ ảnh!';
            setTimeout(() => { ocrStatus.textContent = ''; }, 3000);
        } catch (error) {
            console.error('Error during OCR:', error);
            ocrStatus.textContent = '❌ Lỗi nhận diện ảnh.';
        } finally {
            inputs.input3.disabled = false;
        }
    }

    inputs.input3.addEventListener('paste', (event) => {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                event.preventDefault();
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = (e) => extractTextFromImage(e.target.result.split(',')[1]);
                reader.readAsDataURL(blob);
                return;
            }
        }
    });

    // --- Event Listeners Setup ---
    function setupButton(button, originalText, promptGenerator) {
        button.dataset.originalText = originalText;
        button.addEventListener('click', () => {
            const prompt = promptGenerator();
            getAIResponse(prompt, button);
        });
    }

    setupButton(buttons.btn1, '✨ Phân Tích', () => `Với vai trò là một chuyên gia về PCCC am hiểu sâu sắc các Tiêu chuẩn Việt Nam (TCVN) và Quy chuẩn Việt Nam (QCVN) hiện hành, hãy phân tích sâu các rủi ro tiềm ẩn về cháy nổ và đề xuất các giải pháp giảm thiểu hiệu quả cho tình huống sau: "${inputs.input1.value.trim()}". Luôn ưu tiên viện dẫn các quy định cụ thể từ TCVN/QCVN có liên quan.`);
    setupButton(buttons.btn2, '✨ Lập Kế Hoạch', () => `Với vai trò là một chuyên gia về PCCC, dựa trên các yêu cầu của pháp luật và TCVN hiện hành, hãy xây dựng một kế hoạch diễn tập PCCC chi tiết cho cơ sở được mô tả sau: "${inputs.input2.value.trim()}".`);
    setupButton(buttons.btn3, '✨ Giải Thích', () => `Với vai trò là một chuyên gia về PCCC, hãy giải thích một cách đơn giản, dễ hiểu cho câu hỏi hoặc đoạn trích từ tiêu chuẩn PCCC sau: "${inputs.input3.value.trim()}". Hãy đối chiếu với các quy định liên quan khác trong hệ thống pháp luật PCCC của Việt Nam nếu có. Đặc biệt chú ý đến TCVN 5687:2024 nếu câu hỏi liên quan đến thông gió hoặc hút khói.`);
    setupButton(buttons.btn4, '✨ Tư Vấn Ngay', () => `Với vai trò là một kiến trúc sư chuyên về thiết kế PCCC, hãy đưa ra các giải pháp thiết kế PCCC tối ưu cho công trình được mô tả sau: "${inputs.input4.value.trim()}". Tư vấn phải dựa trên và tuân thủ chặt chẽ các quy định trong QCVN 06:2022/BXD và các TCVN liên quan khác, đặc biệt là TCVN 5687:2024 về tính toán lưu lượng hút khói.`);

    // --- Dynamic Suggestion Logic ---
    async function generateAndShowSuggestions(originalPrompt, originalAnswer) {
        try {
            const suggestionPrompt = `Dựa trên câu hỏi sau của người dùng: "${originalPrompt}" và câu trả lời bạn đã cung cấp: "${originalAnswer}", hãy tạo ra 4 câu hỏi gợi ý tiếp theo có liên quan để người dùng có thể hỏi sâu hơn vào vấn đề. Trả về kết quả dưới dạng một mảng JSON hợp lệ chứa 4 chuỗi ký tự. Ví dụ: ["Câu hỏi 1?", "Câu hỏi 2?", "Câu hỏi 3?", "Câu hỏi 4?"]`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: suggestionPrompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const apiKey = "AIzaSyACWW1mR0t1epof6pnZPwTFERAS2XKiSCA";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error('Suggestion API call failed');
            const result = await response.json();
            const suggestionText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (suggestionText) {
                const suggestions = JSON.parse(suggestionText);
                if (Array.isArray(suggestions) && suggestions.length > 0) {
                    showSuggestions(suggestions);
                    return;
                }
            }
            showSuggestions(); // Fallback
        } catch (error) {
            console.error("Could not generate dynamic suggestions, falling back to default.", error);
            showSuggestions(); // Fallback to default static suggestions
        }
    }

    function showSuggestions(suggestions = null) {
        suggestionButtons.innerHTML = '';
        const defaultSuggestions = [
            `Chi phí dự kiến cho các giải pháp này là bao nhiêu?`,
            `Làm thế nào để huấn luyện PCCC cho nhân viên?`,
            `Quy định pháp luật hiện hành về PCCC cho loại hình này là gì?`,
            `Cần kiểm tra, bảo dưỡng hệ thống PCCC định kỳ như thế nào?`
        ];
        const suggestionsToShow = (Array.isArray(suggestions) && suggestions.length > 0) ? suggestions : defaultSuggestions;
        suggestionsToShow.forEach(text => {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = 'bg-gray-200 text-gray-800 text-sm py-1 px-3 rounded-full hover:bg-gray-300 transition';
            button.addEventListener('click', () => {
                const activeTabInput = document.querySelector('.tab-content.active textarea');
                activeTabInput.value = text;
                activeTabInput.focus();
                const activeTabButton = document.querySelector('.tab-content.active button');
                activeTabButton.click();
            });
            suggestionButtons.appendChild(button);
        });
        suggestionContainer.style.display = 'block';
    }

    // --- Modal Function ---
    function showModal(message) {
        const existingModal = document.getElementById('custom-modal');
        if (existingModal) existingModal.remove();
        const modal = document.createElement('div');
        modal.id = 'custom-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
        const modalContent = document.createElement('div');
        modalContent.className = 'bg-white p-6 rounded-lg text-center shadow-xl max-w-sm w-full';
        const modalText = document.createElement('p');
        modalText.textContent = message;
        modalText.className = 'mb-4';
        const closeButton = document.createElement('button');
        closeButton.textContent = 'Đã hiểu';
        closeButton.className = 'bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700';
        closeButton.onclick = () => modal.remove();
        modalContent.append(modalText, closeButton);
        modal.appendChild(modal);
    }
</script>

</body>
</html>

